name: Manage Ansible ENV

on:
    workflow_dispatch:
        inputs:
            action:
                description: "Action to perform"
                required: true
                type: choice
                options:
                    - Create
                    - Destroy
            ubuntu_count:
                description: "Number of Ubuntu VMs (max 5)"
                required: true
                default: "1"
            centos_count:
                description: "Number of CentOS VMs (max 5)"
                required: true
                default: "1"
            node_name:
                description: "Proxmox node"
                required: true
                default: "proxmox"

jobs:
    Initialize:
        runs-on: self-hosted
        outputs:
            action: ${{ steps.setvars.outputs.action }}
            ubuntu_count: ${{ steps.setvars.outputs.ubuntu_count }}
            centos_count: ${{ steps.setvars.outputs.centos_count }}
            node_name: ${{ steps.setvars.outputs.node_name }}

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Validate & Set Variables
              id: setvars
              run: |
                  ACTION="${{ github.event.inputs.action }}"
                  UBUNTU="${{ github.event.inputs.ubuntu_count }}"
                  CENTOS="${{ github.event.inputs.centos_count }}"
                  NODE="${{ github.event.inputs.node_name }}"

                  if [[ "$ACTION" == "Destroy" ]]; then
                    UBUNTU=0
                    CENTOS=0
                  else
                    if (( UBUNTU > 5 || CENTOS > 5 )); then
                      echo "VM count cannot exceed 5"
                      exit 1
                    fi
                  fi

                  echo "action=$ACTION" >> $GITHUB_OUTPUT
                  echo "ubuntu_count=$UBUNTU" >> $GITHUB_OUTPUT
                  echo "centos_count=$CENTOS" >> $GITHUB_OUTPUT
                  echo "node_name=$NODE" >> $GITHUB_OUTPUT

            - name: Setup SSH key
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.PROXMOX_SSH_KEY }}" > ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519
                  ssh-keygen -y -f ~/.ssh/id_ed25519 > ~/.ssh/id_ed25519.pub
                  ssh-keyscan -H ${{ secrets.PROXMOX_HOST }} >> ~/.ssh/known_hosts

            - name: Create State Directory
              run: mkdir -p /home/ansible/terraform_state/ansible-env

    Terraform-Plan:
        needs: Initialize
        runs-on: self-hosted
        defaults:
            run:
                working-directory: ./Terraform
        env:
            TF_IN_AUTOMATION: true
            TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
            TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
            TF_VAR_node_name: ${{ needs.Initialize.outputs.node_name }}
            TF_VAR_proxmox_ssh_username: ${{ secrets.PROXMOX_SSH_USER }}
            TF_VAR_proxmox_ssh_private_key: ${{ secrets.PROXMOX_SSH_KEY }}
            TF_VAR_ubuntu_count: ${{ needs.Initialize.outputs.ubuntu_count }}
            TF_VAR_centos_count: ${{ needs.Initialize.outputs.centos_count }}

        steps:
            - uses: actions/checkout@v4

            - name: Terraform Init
              run: terraform init -upgrade -input=false

            - name: Terraform Plan
              run: terraform plan -input=false

    Create-Apply:
        needs: [Initialize, Terraform-Plan]
        if: needs.Initialize.outputs.action == 'Create'
        runs-on: self-hosted
        defaults:
            run:
                working-directory: ./Terraform
        env:
            TF_IN_AUTOMATION: true
            TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
            TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
            TF_VAR_node_name: ${{ needs.Initialize.outputs.node_name }}
            TF_VAR_proxmox_ssh_username: ${{ secrets.PROXMOX_SSH_USER }}
            TF_VAR_proxmox_ssh_private_key: ${{ secrets.PROXMOX_SSH_KEY }}
            TF_VAR_ubuntu_count: ${{ needs.Initialize.outputs.ubuntu_count }}
            TF_VAR_centos_count: ${{ needs.Initialize.outputs.centos_count }}

        steps:
            - uses: actions/checkout@v4

            - name: Terraform Init
              run: terraform init -upgrade -input=false

            - name: Terraform Apply
              run: terraform apply -auto-approve -input=false

    Destroy-Environment:
        needs: [Initialize, Terraform-Plan]
        if: needs.Initialize.outputs.action == 'Destroy'
        runs-on: self-hosted
        defaults:
            run:
                working-directory: ./Terraform
        env:
            TF_IN_AUTOMATION: true
            TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
            TF_VAR_proxmox_api_token: ${{ secrets.PROXMOX_API_TOKEN }}
            TF_VAR_node_name: ${{ needs.Initialize.outputs.node_name }}
            TF_VAR_proxmox_ssh_username: ${{ secrets.PROXMOX_SSH_USER }}
            TF_VAR_proxmox_ssh_private_key: ${{ secrets.PROXMOX_SSH_KEY }}
            TF_VAR_ubuntu_count: 0
            TF_VAR_centos_count: 0

        steps:
            - uses: actions/checkout@v4

            - name: Terraform Init
              run: terraform init -upgrade -input=false

            - name: Terraform Destroy
              run: terraform destroy -auto-approve -input=false
